<project name="install tomcat cmd" basedir="." default="cmd">
	
	<!-- 
	#########################################
	# Install Tomcat Engine & Tocmat Instance
	#########################################
	-->
	
	<property file="${basedir}/build.properties" />
	
	<property name="meerkat.agent.home" value="${agent.deploy.dir}/${agent.name}" />
	<property name="down.dir" value="${agent.deploy.dir}/${agent.name}/downloads" />

	<taskdef resource="cargo.tasks">
		<classpath>
			<pathelement location="${meerkat.agent.home}/lib/cargo-core-uberjar-1.4.19.jar" />
			<pathelement location="${meerkat.agent.home}/lib/cargo-ant-1.4.19.jar" />
		</classpath>
	</taskdef>
	
	<target name="create-instance">
		<echo message="making ${catalina.home}" />
		<mkdir dir="${catalina.home}" />
		
		<echo message="making ${catalina.base}" />
		<mkdir dir="${catalina.base}" />

		<echo message="create ${catalina.base}" />

		<cargo containerId="tomcat7x" action="configure">
			<zipUrlInstaller 
					installUrl="${tomcat.down.url}/${tomcat.name}.zip" 
					downloadDir="${down.dir}" 
					extractDir="${down.dir}" />
			
			<configuration home="${catalina.base}">
			</configuration>
		</cargo>
	</target>
	
	<target name="check-installed">
    	<condition property="installed.tomcat">
        	<resourceexists>
                <file file="${catalina.home}/bin/catalina.sh"/>
            </resourceexists>
        </condition>
        <echo>installed.tomcat : ${installed.tomcat}</echo>
    </target>
	
	<target name="copy-catalina-home" depends="create-instance, check-installed" unless="installed.tomcat">
		<copy todir="${catalina.home}" description="copy to catalina.home">
			<fileset dir="${down.dir}/${tomcat.name}/${tomcat.name}"/>
		</copy>
	</target>

	<target name="cmd" depends="copy-catalina-home">

		<echo message="downloading catalina-jmx-remote-7.0.68.jar" />
		<get src="${tomcat.down.url}/catalina-jmx-remote-7.0.68.jar" dest="${catalina.home}/lib"/>

		<copy todir="${catalina.base}" verbose="true" description="copy env/start/stop script.">
		    <fileset dir="${meerkat.agent.home}/scripts" defaultexcludes="true">
		      <include name="*"/>
		    </fileset>
		</copy>

		<chmod dir="${catalina.home}" perm="755" includes="**/*.sh"/>
		<chmod dir="${catalina.base}" perm="755" includes="**/*.sh"/>
		
		<echo message="updating ${catalina.base}/conf/catalina.properties" />

		<propertyfile file="${catalina.base}/conf/catalina.properties" comment="##Generated file - do not modify!">
		     <entry key="am.server.port" 	value="${am.server.port}" 	operation="${am.conf.op}" />
		     <entry key="am.http.port"   	value="${am.http.port}" 	operation="${am.conf.op}" />
		     <entry key="am.uri.encoding"   value="${am.uri.encoding}" 	operation="${am.conf.op}" />
		     <entry key="am.ajp.port"    	value="${am.ajp.port}" 		operation="${am.conf.op}" />
			 <entry key="am.rmi.registry.port"  value="${am.rmi.registry.port}" operation="${am.conf.op}" />
			 <entry key="am.rmi.server.port" 	value="${am.rmi.server.port}" 	operation="${am.conf.op}" />
		</propertyfile>

	</target>

</project>